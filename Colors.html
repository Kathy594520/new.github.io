<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>配色練習遊戲 </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:linear-gradient(180deg,#FEF3C7,#FCE7F3)}
    .swatch{width:84px;height:84px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;border:2px solid rgba(0,0,0,0.06)}
    .swatch.selected{outline:4px solid rgba(0,0,0,0.12);transform:translateY(-4px)}
    .swatch .meta{font-size:10px;margin-top:6px;color:#111;text-align:center}
    .grid-wrap{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .btn{padding:8px 14px;border-radius:10px}
    .wheel-wrap{width:260px;height:260px;display:flex;align-items:center;justify-content:center}
    svg{max-width:100%;height:auto}
    path.segment{transition:stroke-width .18s,filter .18s}
    path.segment.highlight{stroke:#111;stroke-width:4}
    path.segment.correct{stroke:green;stroke-width:3}
    path.segment.wrong{stroke:red;stroke-width:3}
    /* 彩帶效果 */
    .confetti{position:fixed;width:10px;height:10px;top:0;animation:fall 3s linear forwards;opacity:0.9;z-index:60}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}
    /* 結算畫面樣式 */
    #endScreen{z-index:50}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-5xl w-full bg-white p-6 rounded-2xl shadow-lg relative">
    <h1 class="text-2xl font-bold mb-2">🎨 配色練習遊戲 </h1>
    <p class="text-sm text-gray-600 mb-4">練習題型：鄰近色 / 互補色 / 同類色。選好後按「確定答案」。限時 60 秒。</p>

    <div id="gameContainer">
      <div class="flex gap-8 flex-col md:flex-row">
        <div class="flex-1">
          <div id="instruction" class="text-lg font-semibold text-blue-700 mb-3"></div>
          <div id="gameArea" class="grid-wrap mb-4"></div>
          <div class="flex gap-3 mb-3">
            <button id="confirmBtn" class="btn bg-emerald-500 text-white">確定答案</button>
            <button id="nextBtn" class="btn bg-blue-500 text-white">下一題</button>
            <button id="clearBtn" class="btn bg-gray-200">清除選擇</button>
            <button id="toggleLabels" class="btn bg-gray-100">切換色名</button>
            <button id="restartBtn" class="btn bg-red-500 text-white">重新開始</button>
          </div>
          <div class="flex gap-4 items-center mb-3">
            <div id="feedback" class="font-bold text-md"></div>
            <div id="score" class="ml-auto font-semibold text-purple-700">分數：0</div>
            <div id="timer" class="ml-4 font-semibold text-red-600">剩餘時間：60 秒</div>
          </div>
          <div class="text-xs text-gray-500">提示：若是「同類色」，請至少選 3 個並包含畫面上的主色（題目所顯示的主色）。選完後按「確定答案」。</div>
        </div>

        <div class="w-96 flex flex-col items-center">
          <h2 class="font-semibold mb-2">🎡 伊登色環（12 色）</h2>
          <div class="wheel-wrap mb-2">
            <svg id="colorWheel" viewBox="0 0 260 260" width="260" height="260" aria-label="色環示意"></svg>
          </div>
          <div id="wheelLegend" class="text-sm text-gray-700"></div>
          <p class="text-xs text-gray-500 mt-2">色環會依題目自動標示主色、鄰近與互補色；同類色會顯示該色系範圍。</p>
        </div>
      </div>
    </div>

    <!-- 結算頁 -->
    <div id="endScreen" class="hidden absolute inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center rounded-2xl">
      <h2 class="text-3xl font-bold mb-4 text-purple-700">⏰ 時間到！</h2>
      <p id="finalScore" class="text-xl font-semibold mb-6">本次總分：0 分</p>
      <button id="restartBtn2" class="btn bg-red-500 text-white text-lg">重新開始</button>
    </div>
  </div>

  <script>
    // ===== 資料 =====
    const colors = [
      '#FF0000','#FF7F00','#FFFF00','#7FFF00','#00FF00','#00FF7F',
      '#00FFFF','#007FFF','#0000FF','#7F00FF','#FF00FF','#FF007F'
    ];
    const colorNames = ['紅色','橙色','黃色','黃綠色','綠色','藍綠色','青色','藍色','靛色','紫色','洋紅色','玫紅色'];
    const modes = ['鄰近色','互補色','同類色'];

    // ===== 狀態 =====
    let currentMode = '';
    let currentIndex = 0;
    let labelsOn = true;
    let selectedIndices = new Set();
    let score = 0;
    let timeLeft = 60;
    let timerInterval = null;

    // ===== 工具函式 =====
    function hexToRgb(hex){ const h=hex.replace('#',''); return {r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16)} }
    function rgbToHsl(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h=0,s=0,l=(max+min)/2; if(max!==min){ const d=max-min; s = l>0.5 ? d/(2-max-min) : d/(max+min); switch(max){case r: h=(g-b)/d + (g<b?6:0); break; case g: h=(b-r)/d + 2; break; case b: h=(r-g)/d + 4; break;} h/=6;} return {h: Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)} }
    function hueDist(a,b){ let d=Math.abs(a-b); if(d>180) d=360-d; return d }

    // ===== 色環繪製 =====
    const wheel = document.getElementById('colorWheel');
    function drawWheel(){
      wheel.innerHTML = '';
      const cx=130, cy=130, r=110, seg=12;
      for(let i=0;i<seg;i++){
        const start=(i/seg)*360, end=((i+1)/seg)*360;
        const rad1=(start-90)*Math.PI/180, rad2=(end-90)*Math.PI/180;
        const x1=cx + r*Math.cos(rad1), y1=cy + r*Math.sin(rad1);
        const x2=cx + r*Math.cos(rad2), y2=cy + r*Math.sin(rad2);
        const large = (end-start)>180?1:0;
        const d=`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
        const p = document.createElementNS('http://www.w3.org/2000/svg','path');
        p.setAttribute('d',d);
        p.setAttribute('fill',colors[i]);
        p.setAttribute('data-index',i);
        p.classList.add('segment');
        wheel.appendChild(p);
      }
      // center circle
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',26); c.setAttribute('fill','#fff'); c.setAttribute('stroke','#eee');
      wheel.appendChild(c);
      // legend
      const legend = document.getElementById('wheelLegend');
      legend.innerHTML = '';
      for(let i=0;i<colors.length;i++){
        const div = document.createElement('div');
        div.style.display='flex'; div.style.alignItems='center'; div.style.gap='6px'; div.style.marginBottom='4px';
        const sw = document.createElement('span'); sw.style.width='14px'; sw.style.height='14px'; sw.style.display='inline-block'; sw.style.background=colors[i]; sw.style.borderRadius='3px'; sw.style.border='1px solid rgba(0,0,0,0.06)';
        const txt = document.createElement('span'); txt.style.fontSize='12px'; txt.textContent = `${colorNames[i]} ${colors[i]}`;
        div.appendChild(sw); div.appendChild(txt); legend.appendChild(div);
      }
    }

    // ===== 渲染色塊 & 互動 =====
    const gameArea = document.getElementById('gameArea');
    function renderSwatches(){
      gameArea.innerHTML = '';
      colors.forEach((hex,i)=>{
        const wrap = document.createElement('div');
        wrap.className = 'swatch relative';
        wrap.style.background = hex;
        wrap.setAttribute('data-index', i);
        const {r,g,b} = hexToRgb(hex);
        const luminance = (0.299*r + 0.587*g + 0.114*b);
        const textColor = luminance < 140 ? '#fff' : '#111';
        const label = document.createElement('div');
        label.className = 'meta';
        label.style.color = textColor;
        label.innerHTML = labelsOn ? `${colorNames[i]}<br><span style='font-family:monospace;font-size:10px'>${hex}</span>` : `<span style='font-family:monospace;font-size:10px'>${hex}</span>`;
        wrap.appendChild(label);
        wrap.addEventListener('click', ()=> onSwatchClick(i));
        gameArea.appendChild(wrap);
      });
      updateSelectionUI();
    }

    function onSwatchClick(i){
      if(timeLeft <= 0) return; // 若遊戲結束則不接受點選
      if(currentMode === '同類色'){
        if(selectedIndices.has(i)) selectedIndices.delete(i); else selectedIndices.add(i);
      } else {
        if(selectedIndices.has(i)) selectedIndices.clear(); else { selectedIndices.clear(); selectedIndices.add(i); }
      }
      updateSelectionUI();
    }

    function updateSelectionUI(){
      const nodes = gameArea.querySelectorAll('.swatch');
      nodes.forEach(n=>{
        const idx = Number(n.getAttribute('data-index'));
        if(selectedIndices.has(idx)) n.classList.add('selected'); else n.classList.remove('selected');
      });
    }

    // ===== 主要流程：newRound & 建題 =====
    function buildInstruction(){
      if(currentMode === '鄰近色'){
        return `題目：主色為 ${colorNames[currentIndex]}。請從色塊中選出 鄰近色（與主色相鄰的色塊之一）。`;
      } else if(currentMode === '互補色'){
        return `題目：主色為 ${colorNames[currentIndex]}。請從色塊中選出 互補色（色環上相對的色塊）。`;
      } else {
        return `題目：主色為 ${colorNames[currentIndex]}。請選出 3 個以上屬於同一色系的顏色（必須包含主色）。`;
      }
    }

    function newRound(){
      if(timeLeft <= 0) return; // 如果時間到就不產生新題
      selectedIndices.clear();
      currentMode = modes[Math.floor(Math.random()*modes.length)];
      currentIndex = Math.floor(Math.random()*colors.length);
      document.getElementById('instruction').textContent = buildInstruction();
      document.getElementById('feedback').textContent = '';
      renderSwatches();
      drawWheel();
      highlightWheel();
    }

    // ===== 評分邏輯 =====
    function evaluate(){
      if(timeLeft <= 0) return;
      const picked = Array.from(selectedIndices).sort((a,b)=>a-b);
      if(currentMode === '鄰近色'){
        if(picked.length !== 1){ wrong('請只選 1 個顏色作為答案'); return; }
        const n1 = (currentIndex+1)%colors.length; const n2 = (currentIndex-1+colors.length)%colors.length;
        if(picked[0]===n1 || picked[0]===n2){ correct(); } else { wrong('答案不正確。鄰近色應為主色左右相鄰的色塊。'); showCorrect([n1,n2]); }
      } else if(currentMode === '互補色'){
        if(picked.length !== 1){ wrong('請只選 1 個顏色作為答案'); return; }
        const comp = (currentIndex + 6) % colors.length;
        if(picked[0]===comp){ correct(); } else { wrong('答案不正確。互補色位於色環的相對位置。'); showCorrect([comp]); }
      } else if(currentMode === '同類色'){
        if(picked.length < 3){ wrong('請至少選 3 個顏色'); return; }
        if(!selectedIndices.has(currentIndex)){ wrong('答案需包含題目中顯示的主色'); return; }
        const centerHue = rgbToHsl(...Object.values(hexToRgb(colors[currentIndex]))).h;
        const threshold = 60; // 色相容差
        let allWithin = true;
        Array.from(selectedIndices).forEach(idx=>{
          const h = rgbToHsl(...Object.values(hexToRgb(colors[idx]))).h;
          if(hueDist(h, centerHue) > threshold) allWithin = false;
        });
        if(allWithin){ correct(); } else {
          wrong('所選顏色不完全屬於相同色系，請選擇更接近主色的顏色。');
          const expected = [];
          for(let i=0;i<colors.length;i++){
            const h = rgbToHsl(...Object.values(hexToRgb(colors[i]))).h;
            if(hueDist(h, centerHue) <= threshold) expected.push(i);
          }
          showCorrect(expected);
        }
      }
    }

    function correct(){
      document.getElementById('feedback').textContent = '✅ 正確！';
      document.getElementById('feedback').className = 'text-green-600 font-semibold';
      score += 10; document.getElementById('score').textContent = `分數：${score}`;
      highlightWheel(true);
    }
    function wrong(msg){
      document.getElementById('feedback').textContent = msg;
      document.getElementById('feedback').className = 'text-red-600 font-semibold';
      score = Math.max(0, score-5); document.getElementById('score').textContent = `分數：${score}`;
    }

    // ===== 色環顯示正確/錯誤 =====
    function highlightWheel(){
      const segs = wheel.querySelectorAll('path.segment');
      segs.forEach(s=>{ s.classList.remove('highlight','correct','wrong'); s.setAttribute('stroke','transparent'); });
      const main = segs[currentIndex]; if(main){ main.classList.add('highlight'); main.setAttribute('stroke','#111'); }
      if(currentMode === '鄰近色'){
        const n1=(currentIndex+1)%colors.length, n2=(currentIndex-1+colors.length)%colors.length;
        segs[n1].classList.add('correct'); segs[n2].classList.add('correct');
      }
      if(currentMode === '互補色'){
        const comp=(currentIndex+6)%colors.length; segs[comp].classList.add('correct');
      }
      if(currentMode === '同類色'){
        const centerHue = rgbToHsl(...Object.values(hexToRgb(colors[currentIndex]))).h; const thresh=60;
        for(let i=0;i<colors.length;i++){ const h=rgbToHsl(...Object.values(hexToRgb(colors[i]))).h; if(hueDist(h,centerHue)<=thresh) segs[i].classList.add('correct'); }
      }
      // 標示玩家錯的選擇
      const picked = Array.from(selectedIndices);
      if(picked.length){ picked.forEach(idx=>{ if(!segs[idx].classList.contains('correct')) segs[idx].classList.add('wrong'); }); }
    }

    function showCorrect(indices){
      const segs = wheel.querySelectorAll('path.segment');
      segs.forEach(s=>s.classList.remove('wrong'));
      indices.forEach(i=>{ if(segs[i]) segs[i].classList.add('correct'); });
    }

    // ===== 計時與結束 =====
    function startTimer(){
      clearInterval(timerInterval);
      timeLeft = 60;
      document.getElementById('timer').textContent = `剩餘時間：${timeLeft} 秒`;
      timerInterval = setInterval(()=>{
        timeLeft--;
        document.getElementById('timer').textContent = `剩餘時間：${timeLeft} 秒`;
        if(timeLeft <= 0){ clearInterval(timerInterval); endGame(); }
      },1000);
    }

    function endGame(){
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('endScreen').classList.remove('hidden');
      document.getElementById('finalScore').textContent = `本次總分：${score} 分`;
      launchConfetti();
    }

    function launchConfetti(){
      for(let i=0;i<50;i++){
        const confetti=document.createElement('div');
        confetti.className='confetti';
        confetti.style.left = Math.random()*100+'vw';
        confetti.style.backgroundColor = `hsl(${Math.random()*360},100%,50%)`;
        confetti.style.animationDuration = (2+Math.random()*2)+'s';
        document.body.appendChild(confetti);
        setTimeout(()=>confetti.remove(),3500);
      }
    }

    function restartGame(){
      // 回到可遊玩狀態
      score = 0; document.getElementById('score').textContent = `分數：${score}`;
      document.getElementById('feedback').textContent = '';
      document.getElementById('endScreen').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      startTimer();
      newRound();
    }

    // ===== 事件綁定 =====
    document.getElementById('confirmBtn').addEventListener('click', evaluate);
    document.getElementById('nextBtn').addEventListener('click', ()=>{ if(timeLeft>0) newRound(); });
    document.getElementById('clearBtn').addEventListener('click', ()=>{ selectedIndices.clear(); updateSelectionUI(); document.getElementById('feedback').textContent=''; });
    document.getElementById('toggleLabels').addEventListener('click', ()=>{ labelsOn = !labelsOn; renderSwatches(); });
    document.getElementById('restartBtn').addEventListener('click', restartGame);
    document.getElementById('restartBtn2').addEventListener('click', restartGame);

    // ===== 初始化 =====
    drawWheel();
    startTimer();
    newRound();
  </script>
</body>
</html>
